<!DOCTYPE html>
<html>
<head>
    <title>团总的地球Online</title>
    <meta charset="UTF-8">
    <!-- 添加缓存控制 meta 标签 -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    
    <link rel="stylesheet" href="css/swiper-bundle.min.css">
    <link rel="stylesheet" href="layui/css/layui.css">
    <!-- 修改 CSS 引用，添加随机参数 -->
    <link rel="stylesheet" href="css/index.css?v=<?php echo microtime(true); ?>">
    
    <!-- Live2D依赖项 -->
    <script src="js/live2d.min.js"></script>
    <script src="js/live2dcubismcore.min.js"></script>
    <script src="js/pixi.min.js"></script>
    <script src="js/utils.min.js"></script>
    <script src="js/math.min.js"></script>
    <script src="js/index.min.js"></script>
</head>
<body>
    <div class="game-container">
        <!-- 左侧角色面板 -->
        <div class="character-panel panel-base">
            <div class="layui-tab layui-tab-brief custom-tab" lay-filter="characterTab">
                <ul class="layui-tab-title">
                    <li class="layui-this">
                        <i class="layui-icon layui-icon-user"></i>
                        角色信息
                    </li>
                    <li>
                        <i class="layui-icon layui-icon-star"></i>
                        技能
                    </li>
                    <li>
                        <i class="layui-icon layui-icon-fire"></i>
                        荣誉
                    </li>
                </ul>
                <div class="layui-tab-content">
                    <!-- 角色信息选项卡 -->
                    <div class="layui-tab-item layui-show">
                        <div class="character-stats">
                            <div class="stat-group">
                                <div class="stat-item">
                                    <span>生命值</span>
                                    <div class="stat-value">
                                        <div class="stat-bar">
                                            <div class="stat-bar-inner hp"></div>
                                        </div>
                                        <span id="hp">8666/9999</span>
                                    </div>
                                </div>
                                <div class="stat-item">
                                    <span>魔法值</span>
                                    <div class="stat-value">
                                        <div class="stat-bar">
                                            <div class="stat-bar-inner mp"></div>
                                        </div>
                                        <span id="mp">9999/9999</span>
                                    </div>
                                </div>
                            </div>
                            <div class="stat-group">
                                <div class="stat-item">
                                    <span>物攻</span>
                                    <span id="physicalAtk">99999</span>
                                </div>
                                <div class="stat-item">
                                    <span>物防</span>
                                    <span id="physicalDef">99999</span>
                                </div>
                                <div class="stat-item">
                                    <span>法防</span>
                                    <span id="magicDef">99999</span>
                                </div>
                                <div class="stat-item">
                                    <span>速度</span>
                                    <span id="speed">99999</span>
                                </div>
                            </div>
                            <div class="exp-section">
                                <div class="exp-bar">
                                    <div class="exp-bar-inner"></div>
                                </div>
                                <div class="exp-info">
                                    <span class="level">66/100</span>
                                    <span class="exp">75666/99999</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 技能选项卡 -->
                    <div class="layui-tab-item">
                        <div class="skills-list">
                            <div class="empty-tip">暂无技能</div>
                        </div>
                    </div>
                    
                    <!-- 荣誉选项卡 -->
                    <div class="layui-tab-item">
                        <div class="honors-list">
                            <div class="empty-tip">暂无荣誉</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 中间主内容区 -->
        <div class="main-content panel-base">
            <!-- 上半部分：Live2D展示区 -->
            <div class="main-content-top">
                <h2 class="panel-title">
                    <i class="layui-icon layui-icon-location"></i>
                    游戏世界
                    <span class="title-decoration"></span>
                </h2>
                <div id="live2dContainer"></div>
            </div>
            
            <!-- 下半部分：进行中的任务 -->
            <div class="main-content-bottom">
                <h2 class="panel-title">
                    <i class="layui-icon layui-icon-loading"></i>
                    进行中的任务
                    <span class="title-decoration"></span>
                </h2>
                <!-- 任务容器 -->
                <div class="active-tasks-wrapper">
                    <div class="swiper active-tasks-swiper">
                        <div class="swiper-wrapper">
                            <!-- 任务将在这里生成 -->
                        </div>
                        <div class="swiper-pagination"></div>
                        <div class="swiper-button-prev"></div>
                        <div class="swiper-button-next"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 右侧任务列表 -->
        <div class="task-panel panel-base">
            <h2 class="panel-title">
                <i class="layui-icon layui-icon-flag"></i>
                可用任务
                <span class="title-decoration"></span>
            </h2>
            <div id="taskList">
                <!-- 任务卡片将通过JS动态加载 -->
            </div>
        </div>
    </div>

    <!-- WebSocket状态显示 -->
    <div class="websocket-status">
        <span class="status-dot"></span>
        <span class="status-text">WebSocket连接中...</span>
    </div>

    <!-- 脚本引用 -->
    <script src="js/swiper-bundle.min.js"></script>
    <script src="layui/layui.js"></script>
    <script src="js/socket.io.js"></script>
    <script src="js/live2d-config.js"></script>
    <!-- 添加配置文件和工具函数 -->
    <script src="js/config.js"></script>
    <script src="js/utils.js"></script>
    <!-- game.js保持原有的时间戳 -->
    <script src="js/game.js?v=<?php echo microtime(true); ?>"></script>
    <script>
    
    // 将所有初始化逻辑包装在一个异步函数中
    async function initializeApplication() {
        // 等待 DOM 加载完成
        if (document.readyState !== 'complete') {
            await new Promise(resolve => window.addEventListener('load', resolve));
        }

        // 延迟一帧执行初始化，避免与 Layui 的初始化冲突
        await new Promise(resolve => requestAnimationFrame(resolve));

        // 初始化 Layui
        await new Promise(resolve => {
            layui.use(['element'], function() {
                const element = layui.element;
                element.render('tab');
                resolve();
            });
        });

        // 初始化观察器
        const observers = initializeObservers();
        
        // 初始化 Swiper
        initializeSwiper();

        return observers;
    }

    // 观察器初始化函数
    function initializeObservers() {
        // Swiper 观察器
        const swiperObserver = new MutationObserver((mutations) => {
            mutations.forEach((mutation) => {
                if (mutation.type === 'childList') {
                    requestAnimationFrame(initializeSwiper);
                }
            });
        });

        // 任务卡片观察器
        const taskObserver = new MutationObserver((mutations) => {
            mutations.forEach((mutation) => {
                mutation.addedNodes.forEach((node) => {
                    if (node.nodeType === 1) {
                        if (node.classList?.contains('task-card')) {
                            initializeTaskCard(node);
                        }
                        const taskCards = node.getElementsByClassName('task-card');
                        Array.from(taskCards).forEach(initializeTaskCard);
                    }
                });
            });
        });

        // 设置观察器配置
        const config = {
            childList: true,
            subtree: true
        };

        // 监听相关容器
        const containers = [
            document.getElementById('taskList'),
            document.querySelector('.active-tasks-swiper .swiper-wrapper'),
            document.querySelector('.tasks-list')
        ].filter(Boolean);

        containers.forEach(container => {
            taskObserver.observe(container, config);
            // 初始化已存在的任务卡片
            Array.from(container.getElementsByClassName('task-card'))
                .forEach(initializeTaskCard);
        });

        // 监听 Swiper 容器
        const swiperWrapper = document.querySelector('.active-tasks-swiper .swiper-wrapper');
        if (swiperWrapper) {
            swiperObserver.observe(swiperWrapper, config);
        }

        return { swiperObserver, taskObserver };
    }

    // 启动应用
    initializeApplication().catch(console.error);

    // 初始化 Swiper
    function initializeSwiper() {
        const swiperContainer = document.querySelector('.active-tasks-swiper');
        if (swiperContainer) {
            new Swiper('.active-tasks-swiper', {
                slidesPerView: 'auto',
                spaceBetween: 20,
                pagination: {
                    el: '.swiper-pagination',
                    clickable: true
                },
                observer: true,
                observeParents: true,
                observeSlideChildren: true
            });
        }
    }

    // 初始化任务卡片
    function initializeTaskCard(taskCard) {
        const timeElement = taskCard.querySelector('.task-time');
        if (!timeElement) return;
        
        const endtime = parseInt(taskCard.dataset.endtime);
        if (!endtime) return;
        
        const timeUpdateInterval = setInterval(() => {
            const isActive = updateTaskTime(taskCard, endtime);
            if (!isActive) {
                clearInterval(timeUpdateInterval);
                taskCard.classList.add('expired');
            }
        }, 1000);
    }

    // 修改任务卡片创建函数
    function createTaskCard(task) {
        const taskCard = document.createElement('div');
        taskCard.className = 'task-card';
        taskCard.dataset.endtime = task.endtime; // 存储结束时间
        
        const taskTypeInfo = TASK_TYPE_MAP[task.task_type] || {
            text: '未知类型',
            color: '#999',
            icon: 'layui-icon-help'
        };
        
        taskCard.innerHTML = `
            <div class="task-header">
                <span class="task-type" style="color: ${taskTypeInfo.color}">
                    <i class="layui-icon ${taskTypeInfo.icon}"></i>
                    ${taskTypeInfo.text}
                </span>
                <span class="task-time">计算中...</span>
            </div>
            <h3 class="task-name">${task.name}</h3>
            <p class="task-description">${task.description}</p>
            <div class="task-rewards">
                <span class="reward-exp">经验 +${task.points}</span>
                <span class="reward-stamina">体力 -${task.stamina_cost}</span>
            </div>
            <div class="task-progress">
                <div class="progress-bar">
                    <div class="progress-inner" style="width: ${(task.points_earned / task.points * 100) || 0}%"></div>
                </div>
                <span class="progress-text">${task.points_earned || 0}/${task.points}</span>
            </div>
        `;
        
        // 初始化时间显示并设置定时器
        const timeUpdateInterval = setInterval(() => {
            const isActive = updateTaskTime(taskCard, task.endtime);
            if (!isActive) {
                clearInterval(timeUpdateInterval);
                taskCard.classList.add('expired');
            }
        }, 1000);
        
        return taskCard;
    }

    // 保持原有的时间更新函数
    function updateTaskTime(taskElement, endtime) {
        const now = Math.floor(Date.now() / 1000);
        const timeLeft = endtime - now;
        
        if (timeLeft <= 0) {
            taskElement.querySelector('.task-time').textContent = '已过期';
            return false;
        }
        
        const hours = Math.floor(timeLeft / 3600);
        const minutes = Math.floor((timeLeft % 3600) / 60);
        const seconds = timeLeft % 60;
        
        const timeString = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        taskElement.querySelector('.task-time').textContent = `剩余时间：${timeString}`;
        return true;
    }
    </script>
</body>
</html>