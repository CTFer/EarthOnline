<!DOCTYPE html>
<html>
<head>
    <title>团总的地球Online</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/layui@2.9.21/dist/css/layui.css">
    
    <!-- Live2D依赖项 -->
    <!-- 添加Cubism 2运行时 - 使用本地文件 -->
    <script src="js/live2d.min.js"></script>
    <!-- Cubism 3运行时 -->
    <script src="js/live2dcubismcore.min.js"></script>
    <!-- PIXI基础库 -->
    <script src="js/pixi.min.js"></script>
    <!-- PIXI扩展 -->
    <script src="js/utils.min.js"></script>
    <script src="js/math.min.js"></script>
    <!-- Live2D显示插件 -->
    <script src="js/index.min.js"></script>
    
    <!-- 自定义脚本 -->
    <script defer src="js/live2d-config.js"></script>

    <style>
        body {
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #0c1d35 0%, #0a1422 100%);
            color: #fff;
            font-family: "Microsoft YaHei", Arial, sans-serif;
        }

        /* 主容器 */
        .game-container {
            display: flex;
            gap: 20px;
            max-width: 1400px;
            margin: 0 auto;
            position: relative;
        }

        /* 通用面板样式 */
        .panel-base {
            background: rgba(13, 27, 45, 0.95);
            border: 1px solid #1e3148;
            border-radius: 4px;
            position: relative;
        }

        .panel-base::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, 
                transparent,
                rgba(255, 196, 71, 0.5),
                transparent
            );
        }

        /* 左侧角色面板 */
        .character-panel {
            flex: 0 0 300px;
            padding: 20px;
            background: rgba(13, 27, 45, 0.95);
            border: 1px solid #1e3148;
            border-radius: 4px;
        }

        .character-stats {
            margin-top: 15px;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding: 12px;
            background: rgba(21, 39, 63, 0.4);
            border: 1px solid #1e3148;
            border-radius: 2px;
            transition: all 0.3s ease;
        }

        .stat-item:hover {
            background: rgba(30, 49, 72, 0.6);
            border-color: #ffc447;
        }

        .stat-item span:first-child {
            color: #8aa2c1;
            font-size: 14px;
        }

        .stat-item span:last-child {
            color: #ffc447;
            font-weight: bold;
        }

        /* 中间内容区 */
        .main-content {
            flex: 1;
            min-height: 80vh;
            padding: 20px;
            background: rgba(13, 27, 45, 0.95);
            border: 1px solid #1e3148;
            border-radius: 4px;
            display: flex;
            flex-direction: column;
        }

        /* 右侧任务列表 */
        .task-panel {
            flex: 0 0 350px;
            padding: 20px;
            background: rgba(13, 27, 45, 0.95);
            border: 1px solid #1e3148;
            border-radius: 4px;
        }

        /* 任务卡片样式 */
        .task-card {
            background: rgba(21, 39, 63, 0.4);
            border: 1px solid #1e3148;
            border-radius: 2px;
            padding: 15px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .task-card:hover {
            border-color: #ffc447;
            background: rgba(30, 49, 72, 0.6);
        }

        .task-title {
            font-size: 16px;
            color: #ffc447;
            margin-bottom: 10px;
            font-weight: bold;
        }

        .task-desc {
            font-size: 14px;
            color: #8aa2c1;
            margin-bottom: 10px;
            line-height: 1.5;
        }

        .task-status {
            font-size: 12px;
            padding: 4px 12px;
            border-radius: 2px;
            display: inline-block;
            font-weight: bold;
        }

        .status-available {
            background: #2d5a3c;
            color: #6ed47c;
            border: 1px solid #6ed47c;
        }

        .status-in-progress {
            background: #5a4a2d;
            color: #ffc447;
            border: 1px solid #ffc447;
        }

        .status-completed {
            background: #2d4a5a;
            color: #47c9ff;
            border: 1px solid #47c9ff;
        }

        .status-abandoned {
            background: #5a2d2d;
            color: #ff4747;
            border: 1px solid #ff4747;
        }

        /* 标题样式 */
        .panel-title {
            color: #ffc447;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #1e3148;
            font-size: 18px;
            font-weight: bold;
            position: relative;
        }

        .panel-title::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            width: 30px;
            height: 1px;
            background: #ffc447;
        }

        /* 自定义滚动条 */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(13, 27, 45, 0.95);
        }

        ::-webkit-scrollbar-thumb {
            background: #1e3148;
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #ffc447;
        }

        /* layui按钮样式覆盖 */
        .layui-btn {
            background-color: #1e3148;
            border: 1px solid #ffc447;
            color: #ffc447;
        }

        .layui-btn:hover {
            background-color: #ffc447;
            color: #0c1d35;
        }

        /* layui弹窗样式覆盖 */
        .layui-layer {
            background: rgba(13, 27, 45, 0.95) !important;
            border: 1px solid #1e3148 !important;
        }

        .layui-layer-title {
            background: #1e3148 !important;
            color: #ffc447 !important;
            border-bottom: 1px solid #1e3148 !important;
        }

        .layui-layer-btn {
            border-top: 1px solid #1e3148 !important;
        }

        .layui-layer-btn a {
            background-color: #1e3148 !important;
            border: 1px solid #ffc447 !important;
            color: #ffc447 !important;
        }

        .layui-layer-btn a:hover {
            background-color: #ffc447 !important;
            color: #0c1d35 !important;
        }

        /* Live2D容器样式 */
        #live2dContainer {
            flex: 1;
            width: 100%;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            margin-top: 20px;
        }

        #live2dContainer canvas {
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
        }
    </style>
</head>
<body>
    <div class="game-container">
        <!-- 左侧角色面板 -->
        <div class="character-panel">
            <h2 class="panel-title">角色信息</h2>
            <div class="character-stats">
                <div class="stat-item">
                    <span>角色ID</span>
                    <span id="charId">加载中...</span>
                </div>
                <div class="stat-item">
                    <span>用户ID</span>
                    <span id="userId">加载中...</span>
                </div>
                <div class="stat-item">
                    <span>角色名称</span>
                    <span id="playerName">加载中...</span>
                </div>
                <div class="stat-item">
                    <span>创建时间</span>
                    <span id="createTime">加载中...</span>
                </div>
                <div class="stat-item">
                    <span>等级</span>
                    <span id="level">0</span>
                </div>
                <div class="stat-item">
                    <span>经验值</span>
                    <span id="experience">0</span>
                </div>
                <div class="stat-item">
                    <span>体力值</span>
                    <span id="stamina">0/100</span>
                </div>
                <div class="stat-item">
                    <span>智力值</span>
                    <span id="intelligence">0</span>
                </div>
                <div class="stat-item">
                    <span>武力值</span>
                    <span id="strength">0</span>
                </div>
            </div>
        </div>

        <!-- 中间主内容区 -->
        <div class="main-content">
            <h2 class="panel-title">游戏世界</h2>
            <div id="live2dContainer"></div>
        </div>

        <!-- 右侧任务列表 -->
        <div class="task-panel">
            <h2 class="panel-title">可用任务</h2>
            <div id="taskList">
                <!-- 任务卡片将通过JS动态加载 -->
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/layui@2.9.21/dist/layui.js"></script>
    <script>
        // 后端服务器地址配置
        const SERVER = 'http://localhost:5000';  // 可以根据环境修改

        // 初始化layui
        layui.use(['layer'], function(){
            var layer = layui.layer;
            
            // 加载任务列表
            loadTasks();
        });

        // 加载任务列表
        async function loadTasks() {
            try {
                const response = await fetch(`${SERVER}/api/tasks/available`);
                const tasks = await response.json();
                
                const taskList = document.getElementById('taskList');
                taskList.innerHTML = ''; // 清空现有内容

                tasks.forEach(task => {
                    const taskCard = createTaskCard(task);
                    taskList.appendChild(taskCard);
                });
            } catch (error) {
                console.error('加载任务失败:', error);
                layer.msg('加载任务失败', {icon: 2});
            }
        }

        // 创建任务卡片
        function createTaskCard(task) {
            const div = document.createElement('div');
            div.className = 'task-card';
            div.innerHTML = `
                <div class="task-title">${task.title}</div>
                <div class="task-desc">${task.description}</div>
                <div class="task-status status-${task.status.toLowerCase()}">${getStatusText(task.status)}</div>
            `;

            // 添加点击事件
            div.onclick = () => handleTaskClick(task);

            return div;
        }

        // 处理任务点击
        function handleTaskClick(task) {
            if (task.status === 'AVAILABLE') {
                layer.confirm('是否接受该任务？', {
                    btn: ['接受','取消']
                }, function(){
                    acceptTask(task.id);
                });
            } else {
                layer.msg(`任务状态: ${getStatusText(task.status)}`);
            }
        }

        // 接受任务
        async function acceptTask(taskId) {
            try {
                const response = await fetch(`${SERVER}/api/tasks/${taskId}/accept`, {
                    method: 'POST'
                });
                
                if (response.ok) {
                    layer.msg('成功接受任务', {icon: 1});
                    loadTasks(); // 重新加载任务列表
                } else {
                    throw new Error('接受任务失败');
                }
            } catch (error) {
                console.error('接受任务失败:', error);
                layer.msg('接受任务失败', {icon: 2});
            }
        }

        // 获取状态文本
        function getStatusText(status) {
            const statusMap = {
                'AVAILABLE': '可接取',
                'IN_PROGRESS': '进行中',
                'COMPLETED': '已完成',
                'ABANDONED': '已放弃'
            };
            return statusMap[status] || status;
        }

        // 加载角色信息
        async function loadCharacterInfo() {
            try {
                const response = await fetch(`${SERVER}/api/character`);
                const character = await response.json();
                
                if (response.ok) {
                    document.getElementById('charId').textContent = character.id;
                    document.getElementById('userId').textContent = character.user_id;
                    document.getElementById('playerName').textContent = character.player_name;
                    document.getElementById('createTime').textContent = character.create_time;
                    document.getElementById('level').textContent = character.level;
                    document.getElementById('experience').textContent = character.experience;
                    document.getElementById('stamina').textContent = `${character.stamina}/100`;
                    document.getElementById('intelligence').textContent = character.intelligence;
                    document.getElementById('strength').textContent = character.strength;
                } else {
                    throw new Error(character.error || '加载角色信息失败');
                }
            } catch (error) {
                console.error('加载角色信息失败:', error);
                layer.msg('加载角色信息失败: ' + error.message);
            }
        }

        // 页面加载完成后执行
        document.addEventListener('DOMContentLoaded', function() {
            loadCharacterInfo();
            loadTasks();
            initLive2D();  // 初始化Live2D
        });
    </script>
</body>
</html>