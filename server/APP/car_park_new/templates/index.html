<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>停车场月租车管理系统</title>
    <!-- 使用主应用的layui资源 -->
    <link rel="stylesheet" href="/static/layui/css/layui.css" />
    <script>
      // 登录状态标志变量
      window.isAdmin = {% if is_admin %}true{% else %}false{% endif %};
      window.username = "{{ username|default('') }}";
    </script>
    <style>
      .login-status {
        float: right;
        color: #666;
      }
      .login-status a {
        color: #1890ff;
        margin-left: 10px;
      }
    </style>
    <style>
      body {
        margin: 0;
        padding: 0;
        background-color: #f2f2f2;
        font-family: "Microsoft YaHei", Arial, sans-serif;
      }
      .container {
        max-width: 1400px;
        margin: 20px auto;
        padding: 0 15px;
        box-sizing: border-box;
      }
      /* 未登录状态的样式优化 */
      {% if not is_admin %}
      .header {
        text-align: center;
      }
      .header h1 {
        display: block;
        margin: 0 auto 15px auto;
      }
      .login-status {
        float: none;
        margin-top: 10px;
      }
      .login-status a {
        display: inline-block;
        margin: 0;
        padding: 8px 20px;
        background-color: #1890ff;
        color: white;
        text-decoration: none;
        border-radius: 4px;
        transition: all 0.3s ease;
      }
      .login-status a:hover {
        background-color: #40a9ff;
      }
      {% endif %}
      .header {
        background-color: #fff;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 2px 12px 0 rgba(0, 0, 0, 0.1);
      }
      .header h1 {
        margin: 0 0 15px 0;
        color: #333;
        font-size: 24px;
        display: inline-block;
      }
      .stats-container {
        display: flex;
        gap: 20px;
        flex-wrap: wrap;
      }
      .stat-card {
        flex: 1;
        min-width: 150px;
        background-color: #f8f9fa;
        border-radius: 6px;
        padding: 15px;
        text-align: center;
      }
      .stat-number {
        font-size: 28px;
        font-weight: bold;
        margin-bottom: 5px;
      }
      .stat-label {
        color: #666;
        font-size: 14px;
      }
      .total {
        background-color: #e8f4fc;
        color: #1890ff;
      }
      .normal {
        background-color: #f6ffed;
        color: #52c41a;
      }
      .expiring {
        background-color: #fff7e6;
        color: #fa8c16;
      }
      .expired {
        background-color: #fff1f0;
        color: #f5222d;
      }
      .table-container {
        background-color: #fff;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 2px 12px 0 rgba(0, 0, 0, 0.1);
      }
      .refresh-btn {
        margin-bottom: 15px;
        float: right;
      }
      .footer {
        text-align: center;
        margin-top: 20px;
        color: #999;
        font-size: 12px;
      }
      .status-badge {
        display: inline-block;
        padding: 2px 8px;
        border-radius: 10px;
        font-size: 12px;
        font-weight: 500;
      }
      .status-normal {
        background-color: #f6ffed;
        color: #52c41a;
        border: 1px solid #b7eb8f;
      }
      .status-expiring {
        background-color: #fff7e6;
        color: #fa8c16;
        border: 1px solid #ffd591;
      }
      .status-expired {
        background-color: #fff1f0;
        color: #f5222d;
        border: 1px solid #ffccc7;
      }
      .status-unknown {
        background-color: #f5f5f5;
        color: #999;
        border: 1px solid #d9d9d9;
      }

      /* 选项卡样式 */
      .layui-tab {
        margin-bottom: 20px;
      }
      .card {
        background-color: #fff;
        border-radius: 8px;
        padding: 0;
        margin-bottom: 20px;
        box-shadow: 0 2px 12px 0 rgba(0, 0, 0, 0.1);
        overflow: hidden;
      }
      .card-header {
        padding: 15px 20px;
        border-bottom: 1px solid #f0f0f0;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .card-header h3 {
        margin: 0;
        color: #333;
        font-size: 18px;
        font-weight: normal;
      }
      .card-body {
        padding: 20px;
      }
      .card-tools {
        display: flex;
        gap: 10px;
      }

      /* 选项卡内容样式 */
      .tab-content {
        display: none;
      }
      .tab-content.layui-show {
        display: block;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <!-- 导航选项卡 -->
      <div class="layui-tab" lay-filter="mainTab">
        <ul class="layui-tab-title">
          <li class="layui-this" lay-id="tab-index">首页</li>
          {% if is_admin %}
          <li lay-id="tab-renew">续期管理</li>
          <li lay-id="tab-statistics">统计分析</li>
          {% endif %}
        </ul>

        <!-- 首页内容 -->
        <div class="layui-tab-content">
          <div class="layui-tab-item layui-show" id="content-index">
            <div class="header">
              <h1>停车场月租车管理系统</h1>
              {% if is_admin %}
              <div class="login-status">欢迎您，{{ username.username }}！ <a href="/car_park_new/logout">退出登录</a></div>
              {% else %}
              <!-- <div class="login-status">
                <a href="/car_park_new/login">登录管理</a>
              </div> -->
              {% endif %}

              <div class="stats-container">
                <div class="stat-card total">
                  <div class="stat-number">{{ total_cars }}</div>
                  <div class="stat-label">总车辆数</div>
                </div>
                <div class="stat-card normal">
                  <div class="stat-number">{{ normal_cars }}</div>
                  <div class="stat-label">正常</div>
                </div>
                <div class="stat-card expiring">
                  <div class="stat-number">{{ expiring_cars }}</div>
                  <div class="stat-label">即将到期(30天内)</div>
                </div>
                <div class="stat-card expired">
                  <div class="stat-number">{{ expired_cars }}</div>
                  <div class="stat-label">已过期</div>
                </div>
              </div>
              <div style="margin-top: 15px; color: #999; font-size: 14px">最后更新时间: {{ current_time }}</div>
            </div>

            <div class="table-container">
              <!-- 搜索框和刷新按钮在同一行 -->
              <div class="layui-form-item" style="margin: 15px 0; ">
                <div>
                  <div class="layui-input-inline" style="margin-right: 15px;">
                    <input type="text" id="search-car-number" placeholder="车牌号搜索" class="layui-input" />
                  </div>
                  {% if is_admin %}
                  <div class="layui-input-inline" style="margin-right: 15px;">
                    <input type="text" id="search-owner-name" placeholder="车主姓名搜索" class="layui-input" />
                  </div>
                  {% endif %}
                </div>
                {% if is_admin %}
                <button class="layui-btn layui-btn-primary refresh-btn" id="refreshBtn"><i class="layui-icon layui-icon-refresh"></i> 刷新数据</button>
                {% endif %}
              </div>

              <table class="layui-hide" id="carTable" lay-filter="carTable"></table>
            </div>
          </div>

          <!-- 续期管理内容 -->
          <div class="layui-tab-item" id="content-renew">
            <div class="card">
              <div class="card-header">
                <h3>月租车续期管理</h3>
                <div class="card-tools">
                  <button class="layui-btn layui-btn-primary layui-btn-sm" id="btn-add-renew"><i class="layui-icon layui-icon-add-circle"></i> 添加续期记录</button>
                  <button class="layui-btn layui-btn-sm layui-btn-warm" id="btn-refresh-renew"><i class="layui-icon layui-icon-refresh"></i> 刷新数据</button>
                </div>
              </div>
              <div class="card-body">
                <div class="layui-form-item">
                  <div class="layui-input-inline">
                    <input type="text" id="search-owner" placeholder="车主姓名" class="layui-input" />
                  </div>
                  <div class="layui-input-inline">
                    <input type="text" id="search-car" placeholder="车牌号" class="layui-input" />
                  </div>
                  <div class="layui-input-inline">
                    <select id="search-status" lay-search>
                      <option value="">所有状态</option>
                      <option value="pending">待处理</option>
                      <option value="complete">已通过</option>
                      <option value="changed">已修改</option>
                      <option value="change">待修改</option>
                    </select>
                  </div>
                  <button class="layui-btn layui-btn-normal" id="btn-search-renew"><i class="layui-icon layui-icon-search"></i> 查询</button>
                </div>
                <table class="layui-hide" id="renewTable" lay-filter="renewTable"></table>
              </div>
            </div>
          </div>

          <!-- 统计分析内容 -->
          <div class="layui-tab-item" id="content-statistics">
            <div class="card">
              <div class="card-header">
                <h3>统计分析</h3>
              </div>
              <div class="card-body">
                <p>统计分析功能开发中...</p>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="footer">© 2025 停车场管理系统 - 数据来源于停车场数据库</div>
    </div>

    <!-- 工具栏模板 -->
    <script type="text/html" id="toolBar">
      <a class="layui-btn layui-btn-xs" lay-event="view">查看详情</a>
    </script>

    <!-- 续期记录工具栏模板 -->
    <script type="text/html" id="renewBar">
      <a class="layui-btn layui-btn-xs" lay-event="edit">编辑</a>
      <a class="layui-btn layui-btn-xs layui-btn-danger" lay-event="del">删除</a>
    </script>

    <!-- 添加/编辑续期记录弹窗 -->
    <div id="renewForm" style="display: none; padding: 20px">
      <form class="layui-form" lay-filter="renewFormFilter">
        <input type="hidden" name="id" id="renew-id" />
        <div class="layui-form-item">
          <label class="layui-form-label">车主姓名</label>
          <div class="layui-input-block">
            <input type="text" name="owner" lay-verify="required" placeholder="请输入车主姓名" class="layui-input" />
          </div>
        </div>
        <div class="layui-form-item">
          <label class="layui-form-label">车牌号</label>
          <div class="layui-input-block">
            <input type="text" name="car_number" lay-verify="required" placeholder="请输入车牌号" class="layui-input" />
          </div>
        </div>
        <div class="layui-form-item">
          <label class="layui-form-label">续期时长</label>
          <div class="layui-input-block">
            <input type="text" name="time" lay-verify="required" placeholder="如：1个月、3个月" class="layui-input" />
          </div>
        </div>
        <div class="layui-form-item">
          <label class="layui-form-label">状态</label>
          <div class="layui-input-block">
            <select name="status">
              <option value="pending">待处理</option>
              <option value="complete">已通过</option>
              <option value="changed">已修改</option>
              <option value="change">待修改</option>
            </select>
          </div>
        </div>
        <div class="layui-form-item">
          <label class="layui-form-label">备注</label>
          <div class="layui-input-block">
            <textarea name="remark" placeholder="请输入备注信息" class="layui-textarea"></textarea>
          </div>
        </div>
        <div class="layui-form-item">
          <label class="layui-form-label">评论</label>
          <div class="layui-input-block">
            <textarea name="comment" placeholder="请输入评论信息" class="layui-textarea"></textarea>
          </div>
        </div>
      </form>
    </div>

    <script src="/static/layui/layui.js"></script>
    <script>
      layui.use(['table', 'layer', 'form', 'element'], function() {
          var table = layui.table;
          var layer = layui.layer;
          var form = layui.form;
          var element = layui.element;

          // 选项卡切换监听
          element.on('tab(mainTab)', function(data) {
              var layId = this.getAttribute('lay-id');
              // 只有在管理员登录状态下才处理续期管理选项卡
              if (layId === 'tab-renew' && window.isAdmin) {
                  renderRenewTable();
              } else if (layId === 'tab-statistics' && !window.isAdmin) {
                  // 如果尝试访问统计分析选项卡但未登录，可以显示提示或保持在首页
                  layer.msg('请先登录后查看统计分析', {icon: 5});
              } else if (layId !== 'tab-index' && !window.isAdmin) {
                  // 非管理员尝试访问非首页选项卡时，显示提示并切回首页
                  layer.msg('请先登录后使用该功能', {icon: 5});
                  element.tabChange('mainTab', 'tab-index');
              } else if (layId === 'tab-renew' && !window.isAdmin) {
                  // 如果尝试访问续期管理选项卡但未登录
                  var cardBody = document.querySelector('#content-renew .card-body');
                  if (cardBody) {
                      cardBody.innerHTML = '<div style="text-align: center; padding: 40px; color: #999;">请先登录后查看续期管理功能</div>';
                  }
              }
          });

          // 根据登录状态设置列配置
          var cols = window.isAdmin ? [
              {field: 'car_number', title: '车牌号', minWidth: 100, fixed: 'left', sort: true},
              {field: 'expire_time_display', title: '到期时间', minWidth: 100, sort: true},
              {field: 'remaining_days', title: '剩余天数', minWidth: 100, sort: true, templet: function(d) {
                  if (d.remaining_days !== null) {
                      if (d.remaining_days < 0) {
                          return '<span style="color: #f5222d;">已过期' + Math.abs(d.remaining_days) + '天</span>';
                      } else if (d.remaining_days <= 30) {
                          return '<span style="color: #fa8c16;">剩余' + d.remaining_days + '天</span>';
                      } else {
                          return '<span style="color: #52c41a;">剩余' + d.remaining_days + '天</span>';
                      }
                  }
                  return '-';
              }},
              {field: 'owner', title: '车主姓名', minWidth: 100, sort: true},
              {field: 'car_type_name', title: '车辆类型', minWidth: 100, sort: true},
              {field: 'status', title: '状态', minWidth: 100, templet: function(d) {
                  var statusMap = {
                      'normal': {text: '正常', className: 'status-normal'},
                      'expiring': {text: '即将到期', className: 'status-expiring'},
                      'expired': {text: '已过期', className: 'status-expired'},
                      'unknown': {text: '未知', className: 'status-unknown'}
                  };
                  var status = statusMap[d.status] || statusMap.unknown;
                  return '<span class="status-badge ' + status.className + '">' + status.text + '</span>';
              }},
              {field: 'phone', title: '联系电话', minWidth: 120},
              {field: 'address', title: '住址', minWidth: 100},
              {field: 'remark', title: '备注', minWidth: 100},
              {fixed: 'right', title: '操作', toolbar: '#toolBar', minWidth: 120}
          ] : [
              {field: 'car_number', title: '车牌号', minWidth: 120, fixed: 'left', sort: true},
              {field: 'expire_time_display', title: '到期时间', minWidth: 120, sort: true},
              {field: 'remaining_days', title: '剩余天数', minWidth: 100, sort: true, templet: function(d) {
                  if (d.remaining_days !== null) {
                      if (d.remaining_days < 0) {
                          return '<span style="color: #f5222d;">已过期' + Math.abs(d.remaining_days) + '天</span>';
                      } else if (d.remaining_days <= 30) {
                          return '<span style="color: #fa8c16;">剩余' + d.remaining_days + '天</span>';
                      } else {
                          return '<span style="color: #52c41a;">剩余' + d.remaining_days + '天</span>';
                      }
                  }
                  return '-';
              }},
              {field: 'car_type_name', title: '车辆类型', minWidth: 120, sort: true},
              {field: 'status', title: '状态', minWidth: 100, templet: function(d) {
                  var statusMap = {
                      'normal': {text: '正常', className: 'status-normal'},
                      'expiring': {text: '即将到期', className: 'status-expiring'},
                      'expired': {text: '已过期', className: 'status-expired'},
                      'unknown': {text: '未知', className: 'status-unknown'}
                  };
                  var status = statusMap[d.status] || statusMap.unknown;
                  return '<span class="status-badge ' + status.className + '">' + status.text + '</span>';
              }}
          ];

          // 渲染车辆列表表格
          table.render({
              elem: '#carTable',
              data: {{ cars|tojson }},
              page: true,
              limit: 20,
              limits: [10, 20, 50, 100],
              height: 'full-120',
              title: '月租车信息表',
              cols: [cols],
              // 设置默认排序，按照到期时间从近到远
              initSort: {
                  field: 'expire_time_display',
                  type: 'asc'
              },
              done: function() {
                  // 表格渲染完成后的回调
                  layer.closeAll('loading');
              },
              // 单元格最小宽度
              cellMinWidth: 80,
              // 开启单元格内容溢出处理
              text: {
                  none: '暂无相关数据'
              },
              // 开启隔行变色
              even: true

          });

          // 刷新按钮事件
          // 只有在刷新按钮存在时才绑定事件
          var refreshBtn = document.getElementById('refreshBtn');
          if (refreshBtn) {
              refreshBtn.onclick = function() {
                  layer.load(2);
                  setTimeout(function() {
                      window.location.href = '/car_park_new/';
                  }, 500);
              };
          }
          
          // 搜索功能实现 - 避免回调地狱
          var searchCarNumber = document.getElementById('search-car-number');
          var searchOwnerName = document.getElementById('search-owner-name');
          var isAdmin = {% if is_admin %}true{% else %}false{% endif %};
          
          // 保存原始数据的副本
          var originalCarData = {{ cars|tojson }};
          
          // 车牌搜索
          searchCarNumber.addEventListener('input', function() {
              filterTable();
          });
          
          // 只有管理员才添加车主姓名搜索事件监听
          if (isAdmin && searchOwnerName) {
              searchOwnerName.addEventListener('input', function() {
                  filterTable();
              });
          }
          
          // 表格过滤函数 - 简化版本，避免循环调用
          function filterTable() {
              var carNumber = searchCarNumber.value.toLowerCase();
              
              // 直接过滤原始数据
              var filteredData = originalCarData.filter(function(item) {
                  // 车牌号匹配
                  var carMatch = !carNumber || (item.car_number && item.car_number.toLowerCase().includes(carNumber));
                  
                  // 只有管理员才进行车主姓名匹配
                  if (isAdmin && searchOwnerName) {
                      var ownerName = searchOwnerName.value.toLowerCase();
                      var ownerMatch = !ownerName || (item.owner && item.owner.toLowerCase().includes(ownerName));
                      return carMatch && ownerMatch;
                  }
                  
                  // 非管理员只进行车牌号匹配
                  return carMatch;
              });
              
              // 直接重新渲染表格，不使用done回调
              table.reload('carTable', {
                  data: filteredData,
                  page: {
                      curr: 1 // 重置到第一页
                  }
              });
          }

          // 监听车辆表格行工具事件
          table.on('tool(carTable)', function(obj) {
              var data = obj.data;
              if (obj.event === 'view') {
                  // 查看详情
                  layer.open({
                      type: 1,
                      title: '车辆详细信息',
                      area: ['600px', '400px'],
                      content: '<div style="padding: 20px;">' +
                          '<p><strong>车牌号:</strong> ' + data.car_number + '</p>' +
                          '<p><strong>车主姓名:</strong> ' + data.owner + '</p>' +
                          '<p><strong>车辆类型:</strong> ' + data.car_type_name + '</p>' +
                          '<p><strong>到期时间:</strong> ' + data.expire_time_display + '</p>' +
                          '<p><strong>剩余天数:</strong> ' + (data.remaining_days !== null ?
                              (data.remaining_days < 0 ? '已过期' + Math.abs(data.remaining_days) + '天' : '剩余' + data.remaining_days + '天') : '未知') + '</p>' +
                          '<p><strong>联系电话:</strong> ' + (data.phone || '-') + '</p>' +
                          '<p><strong>住址:</strong> ' + (data.address || '-') + '</p>' +
                          '<p><strong>备注:</strong> ' + (data.remark || '-') + '</p>' +
                          '</div>'
                  });
              }
          });

          // 续期记录表格实例
          var renewTable = null;
          // 保存续期记录的原始数据
          var originalRenewData = [];

          // 渲染续期记录表格
          function renderRenewTable() {
              if (renewTable) {
                  renewTable.reload();
              } else {
                  layer.load(2);
                  fetch('/car_park_new/api/car_park')
                      .then(response => response.json())
                      .then(data => {
                          layer.closeAll('loading');
                          if (data.code === 0) {
                              // 保存原始数据
                              originalRenewData = data.data.records;
                              renewTable = table.render({
                              elem: '#renewTable',
                              data: data.data.records,
                              page: true,
                              limit: 20,
                              limits: [10, 20, 50, 100],
                              height: 'full-120',
                              title: '续期记录表',
                              cols: [[
                                  {field: 'id', title: 'ID', minWidth: 80},
                                  {field: 'owner', title: '车主姓名', minWidth: 100, sort: true},
                                  {field: 'car_number', title: '车牌号', minWidth: 120, sort: true},
                                  {field: 'time', title: '续期时长', minWidth: 100},
                                  {field: 'addtime', title: '添加时间', minWidth: 160, sort: true},
                                  {field: 'status', title: '状态', minWidth: 100, templet: function(d) {
                                      var statusMap = {
                                          'pending': {text: '待处理', className: 'layui-bg-primary'},
                                          'complete': {text: '已通过', className: 'layui-bg-green'},
                                          'changed': {text: '已修改', className: 'layui-bg-blue'},
                                          'change': {text: '待修改', className: 'layui-bg-primary'}
                                      };
                                      var status = statusMap[d.status] || {text: '未知', className: 'layui-btn-disabled'};
                                      return '<button class="layui-btn layui-btn-xs ' + status.className + '">' + status.text + '</button>';
                                  }},
                                  {field: 'remark', title: '备注', minWidth: 200, templet: function(d) {
                                      return d.remark || '-';
                                  }},
                                  {fixed: 'right', title: '操作', toolbar: '#renewBar', minWidth: 120}
                              ]],
                              cellMinWidth: 80,
                              even: true
                          });
                          } else {
                              layer.msg('获取续期记录失败: ' + (data.msg || '未知错误'), {icon: 5});
                          }
                      })
                      .catch(error => {
                          layer.closeAll('loading');
                          layer.msg('获取续期记录异常', {icon: 5});
                          console.error('Error:', error);
                      });
              }
          }

          // 续期记录表格过滤函数
          function filterRenewTable() {
              var owner = document.getElementById('search-owner').value.toLowerCase();
              var car = document.getElementById('search-car').value.toLowerCase();
              var status = document.getElementById('search-status').value;
              
              // 直接过滤原始数据
              var filteredData = originalRenewData.filter(function(item) {
                  var ownerMatch = !owner || (item.owner && item.owner.toLowerCase().includes(owner));
                  var carMatch = !car || (item.car_number && item.car_number.toLowerCase().includes(car));
                  var statusMatch = !status || item.status === status;
                  
                  return ownerMatch && carMatch && statusMatch;
              });
              
              // 直接重新渲染表格
              table.reload('renewTable', {
                  data: filteredData,
                  page: {
                      curr: 1 // 重置到第一页
                  }
              });
          }

          // 监听续期记录表格行工具事件
          table.on('tool(renewTable)', function(obj) {
              var data = obj.data;
              if (obj.event === 'edit') {
                  // 编辑续期记录
                  editRenewRecord(data);
              } else if (obj.event === 'del') {
                  // 删除续期记录
                  deleteRenewRecord(data.id);
              }
          });

          // 添加续期记录按钮事件
          document.getElementById('btn-add-renew').onclick = function() {
              addRenewRecord();
          };

          // 刷新续期数据按钮事件
          document.getElementById('btn-refresh-renew').onclick = function() {
              renderRenewTable();
          };

          // 查询续期记录按钮事件
          document.getElementById('btn-search-renew').onclick = function() {
              // 使用过滤函数来实现查询
              filterRenewTable();
          };
          
          // 车主姓名搜索输入事件
          document.getElementById('search-owner').addEventListener('input', function() {
              filterRenewTable();
          });
          
          // 车牌号搜索输入事件
          document.getElementById('search-car').addEventListener('input', function() {
              filterRenewTable();
          });
          
          // 状态选择变化事件
          form.on('select(search-status)', function() {
              filterRenewTable();
          });

          // 添加续期记录
          function addRenewRecord() {
              // 重置表单
              form.val('renewFormFilter', {});
              document.getElementById('renew-id').value = '';

              // 打开弹窗
              layer.open({
                  type: 1,
                  title: '添加续期记录',
                  content: document.getElementById('renewForm'),
                  area: ['600px', '500px'],
                  btn: ['确定', '取消'],
                  yes: function(index, layero) {
                      // 验证表单
                      if (!form.validate('renewFormFilter')) {
                          return;
                      }

                      // 获取表单数据
                      var formData = form.val('renewFormFilter');
                      formData.addtime = new Date().toLocaleString('zh-CN');

                      layer.load(2);
                      // 发送请求
                      fetch('/car_park_new/api/car_park', {
                          method: 'POST',
                          headers: {
                              'Content-Type': 'application/json'
                          },
                          body: JSON.stringify(formData)
                      })
                      .then(response => response.json())
                      .then(data => {
                          layer.closeAll('loading');
                          if (data.code === 0) {
                              layer.msg('添加成功', {icon: 6});
                              layer.close(index);
                              renderRenewTable();
                          } else {
                              layer.msg('添加失败: ' + (data.msg || '未知错误'), {icon: 5});
                          }
                      })
                      .catch(error => {
                          layer.closeAll('loading');
                          layer.msg('添加异常', {icon: 5});
                          console.error('Error:', error);
                      });
                  }
              });
          }

          // 编辑续期记录
          function editRenewRecord(data) {
              // 填充表单数据
              form.val('renewFormFilter', {
                  'id': data.id,
                  'owner': data.owner,
                  'car_number': data.car_number,
                  'time': data.time,
                  'status': data.status,
                  'remark': data.remark || '',
                  'comment': data.comment || ''
              });

              // 打开弹窗
              layer.open({
                  type: 1,
                  title: '编辑续期记录',
                  content: document.getElementById('renewForm'),
                  area: ['600px', '500px'],
                  btn: ['确定', '取消'],
                  yes: function(index, layero) {
                      // 验证表单
                      if (!form.validate('renewFormFilter')) {
                          return;
                      }

                      // 获取表单数据
                      var formData = form.val('renewFormFilter');
                      var recordId = formData.id;
                      delete formData.id; // 从更新数据中移除id

                      layer.load(2);
                      // 发送请求
                      fetch('/car_park_new/api/car_park/' + recordId, {
                          method: 'PUT',
                          headers: {
                              'Content-Type': 'application/json'
                          },
                          body: JSON.stringify(formData)
                      })
                      .then(response => response.json())
                      .then(data => {
                          layer.closeAll('loading');
                          if (data.code === 0) {
                              layer.msg('更新成功', {icon: 6});
                              layer.close(index);
                              renderRenewTable();
                          } else {
                              layer.msg('更新失败: ' + (data.msg || '未知错误'), {icon: 5});
                          }
                      })
                      .catch(error => {
                          layer.closeAll('loading');
                          layer.msg('更新异常', {icon: 5});
                          console.error('Error:', error);
                      });
                  }
              });
          }

          // 删除续期记录
          function deleteRenewRecord(recordId) {
              layer.confirm('确定要删除这条续期记录吗？', {
                  btn: ['确定', '取消']
              }, function(index) {
                  layer.load(2);
                  // 发送删除请求
                  fetch('/car_park_new/api/car_park/' + recordId, {
                      method: 'DELETE'
                  })
                  .then(response => response.json())
                  .then(data => {
                          layer.closeAll('loading');
                          if (data.code === 0) {
                              layer.msg('删除成功', {icon: 6});
                              renderRenewTable();
                          } else {
                              layer.msg('删除失败: ' + (data.msg || '未知错误'), {icon: 5});
                          }
                  })
                  .catch(error => {
                      layer.closeAll('loading');
                      layer.msg('删除异常', {icon: 5});
                      console.error('Error:', error);
                  });
                  layer.close(index);
              });
          }

          // 自动刷新功能 (仅对首页生效)
          setInterval(function() {
              // 检查当前是否在首页选项卡
              var activeTab = document.querySelector('.layui-tab-title li.layui-this');
              if (activeTab && activeTab.getAttribute('lay-id') === 'tab-index') {
                  // 每10分钟自动刷新一次
                  layer.load(2);
                  setTimeout(function() {
                      window.location.href = '/car_park_new/';
                  }, 500);
              }
          }, 600000); // 10分钟 = 600000毫秒

          // 初始化表单
          form.render();
      });
    </script>
  </body>
</html>
