<!DOCTYPE html>
<html lang="zh-cn">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>轨迹系统 - 管理</title>
    <link rel="stylesheet" href="{{ url_for('route.static', filename='layui/css/layui.css') }}" />
    <link rel="stylesheet" href="{{ url_for('route.static', filename='style.min.css') }}" />
    <script src="{{ url_for('route.static', filename='layui/layui.js') }}"></script>
    <style>
      .admin-container {
        padding: 20px;
      }
      .header-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding: 10px 0;
        border-bottom: 1px solid #e6e6e6;
      }
      .title {
        font-size: 20px;
        font-weight: bold;
        color: #333;
      }
      .logout-btn {
        background-color: #f56c6c;
      }
      .logout-btn:hover {
        background-color: #e64340;
      }
      .form-section {
        background-color: #fff;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      .list-section {
        background-color: #fff;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      .btn-group {
        display: flex;
        gap: 10px;
      }
    </style>
  </head>
  <body>
    <div class="admin-container">
      <div class="header-bar">
        <div class="title">轨迹管理系统</div>
        <div class="user-info">
          <a href="{{ url_for('route.index') }}" class="layui-btn layui-btn-sm layui-btn-primary">
            返回首页
          </a>
          &nbsp;&nbsp;欢迎回来，{{ username }}！ 
          <button class="layui-btn layui-btn-sm logout-btn" id="logout">退出登录</button>
        </div>
      </div>
      
      <!-- 添加数据表单 -->
      <div class="form-section">
        <h3>添加路线</h3>
        <form class="layui-form layui-row" id="route-form" lay-filter="route-form">
          <input type="hidden" name="id" id="route-id" />
          <div class="layui-col-xs12 layui-col-sm6 layui-col-md6 layui-col-lg3">
            <div class="layui-form-item">
              <label class="layui-form-label">日期</label>
              <div class="layui-input-inline layui-input-wrap">
                <div class="layui-input-prefix">
                  <i class="layui-icon layui-icon-date"></i>
                </div>
                <input type="text" name="date" id="date" placeholder="yyyy-MM-dd HH:mm:ss" autocomplete="off" class="layui-input" required />
              </div>
            </div>
          </div>
          <!-- 出行方式 -->
          <div class="layui-col-xs12 layui-col-sm6 layui-col-md6 layui-col-lg3">
            <div class="layui-form-item">
              <label class="layui-form-label">方式</label>
              <div class="layui-input-inline">
                <select name="method">
                  <option value="plane">飞机</option>
                  <option value="train">火车</option>
                  <option value="drive">自驾</option>
                  <option value="bus">汽车</option>
                  <option value="boat">轮船</option>
                </select>
              </div>
            </div>
          </div>
          <div class="layui-col-xs12 layui-col-sm6 layui-col-md6 layui-col-lg3">
            <div class="layui-form-item">
              <label class="layui-form-label">出发地</label>
              <div class="layui-input-inline">
                <select name="start" class="start" lay-verify="required" lay-search></select>
              </div>
            </div>
          </div>
          <div class="layui-col-xs12 layui-col-sm6 layui-col-md6 layui-col-lg3">
            <div class="layui-form-item">
              <label class="layui-form-label">目的地</label>
              <div class="layui-input-inline">
                <select name="end" class="end" lay-verify="required" lay-search></select>
              </div>
            </div>
          </div>

          <div class="layui-col-xs12">
            <div class="layui-col-xs12 layui-col-sm6 layui-col-md6 layui-col-lg3">
              <div class="layui-form-item">
                <label class="layui-form-label">备注</label>
                <div class="layui-input-inline">
                  <input name="remark" class="layui-input remark" />
                </div>
              </div>
            </div>
            <div class="layui-col-xs12 layui-col-sm6 layui-col-md6 layui-col-lg3">·</div>
            <div class="layui-col-xs12 layui-col-sm6 layui-col-md6 layui-col-lg3">·</div>
            <div class="layui-col-xs12 layui-col-sm6 layui-col-md6 layui-col-lg3">
              <div class="layui-form-item right mr-30">
                <div class="btn-group">
                  <button type="button" class="layui-btn" id="btn-add">添加</button>
                  <button type="button" class="layui-btn layui-btn-normal" id="btn-update" style="display: none;">更新</button>
                  <button type="button" class="layui-btn layui-btn-primary" id="btn-cancel" style="display: none;">取消</button>
                  <button class="layui-btn layui-bg-blue" id="btn-exchange">交换</button>
                </div>
              </div>
            </div>
          </div>
        </form>
      </div>

      <!-- 路线列表 -->
      <div class="list-section">
        <h3>路线列表</h3>
        <table class="layui-table" id="list-table" lay-filter="list-table"></table>
      </div>
      
      <!-- 操作按钮模板 -->
      <script type="text/html" id="operation-toolbar">
        <button class="layui-btn layui-btn-xs" lay-event="edit">编辑</button>
        <button class="layui-btn layui-btn-xs layui-btn-danger" lay-event="delete">删除</button>
      </script>
    </div>

    <script src="{{ url_for('route.static', filename='layui/jquery-3.6.0.min.js') }}"></script>
    <script>
      layui.use(['form', 'laydate', 'table'], function() {
        var form = layui.form;
        var laydate = layui.laydate;
        var table = layui.table;
        
        // 日期时间选择器
        laydate.render({
          elem: '#date',
          type: 'datetime',
          format: 'yyyy-MM-dd HH:mm:ss'
        });

        // 加载城市列表
        function loadCityList() {
          $.ajax({
            url: "{{ url_for('route.get_city_list') }}",
            type: 'GET',
            dataType: 'json',
            success: function(data) {
              var startSelect = $('.start');
              var endSelect = $('.end');
              
              data.forEach(function(cityItem) {
                // 从城市对象中提取name属性
                startSelect.append('<option value="' + cityItem.name + '">' + cityItem.name + '</option>');
                endSelect.append('<option value="' + cityItem.name + '">' + cityItem.name + '</option>');
              });
              
              form.render('select');
            }
          });
        }

        // 初始化表格
        var routeTable = table.render({
          elem: '#list-table',
          page: true,  // 开启分页
          limit: 50,
          limits: [50, 100, 200],
          cellMinWidth: 80,
          cols: [
            [
              {field: '0', title: 'ID', width: 80, sort: true},
              {field: '1', title: '时间', width: 180, sort: true, templet: function(d) {
                return formatDate(d[1]);
              }},
              {field: '2', title: '方式', width: 150, templet: function(d) {
                var methodText = {
                  'plane': '飞机',
                  'train': '火车',
                  'drive': '自驾',
                  'bus': '汽车',
                  'boat': '轮船'
                };
                return methodText[d[2]] || d[2];
              }},
              {field: '3', title: '出发地', width: 150},
              {field: '4', title: '目的地', width: 150},
              {field: '9', title: '备注', templet: function(d) {
                return d[9] || '-';
              }},
              {title: '操作', width: 150, toolbar: '#operation-toolbar'}
            ]
          ],
          done: function() {
            // 表格渲染完成后的回调
            console.log('表格渲染完成');
          }
        });
        
        // 加载所有数据并在前端进行分页
        function loadAllRouteData() {
          $.ajax({
            url: "{{ url_for('route.list_route') }}",
            type: 'GET',
            dataType: 'json',
            success: function(data) {
              // 按时间升序排序数据（最早的在前面）
              data.sort(function(a, b) {
                // 确保时间戳是数字类型
                var timeA = typeof a[1] === 'string' ? parseInt(a[1]) : a[1];
                var timeB = typeof b[1] === 'string' ? parseInt(b[1]) : b[1];
                return timeA - timeB; // 升序排序
              });
              
              // 更新表格数据
              routeTable.reload({
                data: data,
                // 配置分页参数
                page: {
                  curr: 1,  // 重置为第1页
                  limit: 50
                },
                // 本地分页，不发送请求到服务器
                url: '',
                method: 'get'
              });
            },
            error: function() {
              console.error('加载路线数据失败');
            }
          });
        }
        
        // 监听表格工具事件
        table.on('tool(list-table)', function(obj) {
          var data = obj.data;
          if (obj.event === 'edit') {
            // 编辑操作
            $.ajax({
              url: "{{ url_for('route.edit_route') }}",
              type: 'GET',
              data: { id: data[0] },
              dataType: 'json',
              success: function(route) {
                if (route.error) {
                  alert(route.error);
                  return;
                }
                
                form.val('route-form', {
                  'id': route[0],
                  'date': formatDate(route[1]),
                  'method': route[2],
                  'start': route[3],
                  'end': route[4],
                  'remark': route[5]
                });
                
                // 切换按钮显示
                $('#btn-add').hide();
                $('#btn-update').show();
                $('#btn-cancel').show();
              }
            });
          } else if (obj.event === 'delete') {
            // 删除操作
            layer.confirm('确定要删除这条记录吗？', {
              title: '删除确认',
              btn: ['确定', '取消']
            }, function(index) {
              // 关闭确认对话框
              layer.close(index);
              
              $.ajax({
                url: "{{ url_for('route.delete_route') }}",
                type: 'POST',
                data: { id: data[0] },
                dataType: 'json',
                success: function(result) {
                  if (result.success) {
                    layer.msg('删除成功', {icon: 1});
                    // 重新加载所有数据并刷新表格，保持前端分页
                    loadAllRouteData();
                  } else {
                    layer.msg('删除失败: ' + (result.error || '未知错误'), {icon: 2});
                  }
                },
                error: function() {
                  layer.msg('删除失败，请稍后重试', {icon: 2});
                }
              });
            });
          }
        });

        // 格式化日期
        function formatDate(timestamp) {
          if (timestamp.toString().length === 10) {
            return new Date(parseInt(timestamp) * 1000).toLocaleString('zh-CN');
          }
          return timestamp;
        }

        // 交换出发地和目的地
        $('#btn-exchange').click(function() {
          var start = $('.start').val();
          var end = $('.end').val();
          $('.start').val(end);
          $('.end').val(start);
          form.render('select');
        });

        // 添加路线
        $('#btn-add').click(function() {
          var data = form.val('route-form');
          
          if (!data.date || !data.start || !data.end) {
            layer.msg('请填写必填项', {icon: 2});
            return;
          }
          
          // 将日期字符串转换为时间戳
          var timestamp = new Date(data.date).getTime() / 1000; // 转换为秒级时间戳
          data.date = timestamp;
          
          $.ajax({
            url: "{{ url_for('route.add_route') }}",
            type: 'POST',
            data: data,
            dataType: 'json',
            success: function(result) {
              if (result && result.success !== false) {
                layer.msg('添加成功', {icon: 1});
                form.val('route-form', {});
                // 重新加载所有数据并刷新表格，保持前端分页
                loadAllRouteData();
              } else {
                layer.msg('添加失败: ' + (result.error || '未知错误'), {icon: 2});
              }
            },
            error: function() {
              layer.msg('添加失败，请稍后重试', {icon: 2});
            }
          });
        });

        // 编辑路线功能已通过表格工具事件处理

        // 更新路线
        $('#btn-update').click(function() {
          var data = form.val('route-form');
          
          if (!data.date || !data.start || !data.end) {
            layer.msg('请填写必填项', {icon: 2});
            return;
          }
          
          // 将日期字符串转换为时间戳
          var timestamp = new Date(data.date).getTime() / 1000; // 转换为秒级时间戳
          data.date = timestamp;
          
          $.ajax({
            url: "{{ url_for('route.edit_route') }}",
            type: 'POST',
            data: data,
            dataType: 'json',
            success: function(result) {
              if (result.success) {
                layer.msg('更新成功', {icon: 1});
                resetForm();
                // 重新加载所有数据并刷新表格，保持前端分页
                loadAllRouteData();
              } else {
                layer.msg('更新失败: ' + (result.error || '未知错误'), {icon: 2});
              }
            },
            error: function() {
              layer.msg('更新失败，请稍后重试', {icon: 2});
            }
          });
        });

        // 取消编辑
        $('#btn-cancel').click(function() {
          resetForm();
        });

        // 删除路线功能已通过表格工具事件处理

        // 重置表单
        function resetForm() {
          form.val('route-form', {});
          $('#btn-add').show();
          $('#btn-update').hide();
          $('#btn-cancel').hide();
        }

        // 退出登录
        $('#logout').click(function() {
          window.location.href = "{{ url_for('route.logout') }}";
        });

        // 初始化
        loadCityList();
        loadAllRouteData();
      });
    </script>
  </body>
</html>