layui.use(["jquery", "layer", "form"], function () {
  const $ = layui.jquery;
  const layer = layui.layer;
  const form = layui.form;

  console.log("[Roadmap] Initializing roadmap module");

  // 定义颜色选项 - 明亮模式和暗黑模式
  const colorOptions = {
    light: {
      "layui-bg-blue": "#1e9fff", // 经典蓝
      "layui-bg-green": "#16b777", // 清新绿
      "layui-bg-cyan": "#3f51b5", // 深蓝色
      "layui-bg-orange": "#ffb800", // 警示色
      "layui-bg-red": "#ff5722", // 错误色
      "layui-bg-purple": "#a233c6", // 紫色
      "layui-bg-gray": "#fafafa", // 浅灰
    },
    dark: {
      "layui-bg-blue": "#0d47a1", // 深蓝
      "layui-bg-green": "#1b5e20", // 深绿
      "layui-bg-cyan": "#283593", // 深蓝色（暗色版）
      "layui-bg-orange": "#e65100", // 深橙
      "layui-bg-red": "#b71c1c", // 深红
      "layui-bg-purple": "#4a148c", // 深紫
      "layui-bg-gray": "#424242", // 深灰
    },
  };

  // 获取当前主题的颜色选项
  function getCurrentThemeColors() {
    return document.body.classList.contains("dark-mode") ? colorOptions.dark : colorOptions.light;
  }

  // 更新任务卡片颜色
  function updateTaskCardsColor() {
    console.log("[Roadmap] Updating task cards color");
    const colors = getCurrentThemeColors();
    const lightColors = colorOptions.light;
    const darkColors = colorOptions.dark;

    $(".task-card").each(function () {
      const $card = $(this);
      const currentColor = $card.css("background-color");
      console.log("[Roadmap] Current card color:", currentColor);

      // 检查当前颜色是否匹配任何主题色值
      for (const [className, lightColor] of Object.entries(lightColors)) {
        const lightRGB = getRGBColor(lightColor);
        const darkRGB = getRGBColor(darkColors[className]);

        // 如果当前颜色匹配任一主题的颜色，则更新为目标主题的对应颜色
        if (currentColor === lightRGB || currentColor === darkRGB) {
          const newColor = colors[className];
          console.log("[Roadmap] Updating card color to:", newColor);
          $card.css("background-color", newColor).css("border-left-color", newColor);
          break;
        }
      }
    });
  }

  // 将十六进制颜色转换为RGB格式
  function getRGBColor(hex) {
    const r = parseInt(hex.slice(1, 3), 16);
    const g = parseInt(hex.slice(3, 5), 16);
    const b = parseInt(hex.slice(5, 7), 16);
    return `rgb(${r}, ${g}, ${b})`;
  }

  // 更新颜色选择器的颜色
  function updateColorOptions() {
    const colors = getCurrentThemeColors();
    const $colorOptions = $(".color-picker-container");
    if ($colorOptions.length) {
      $colorOptions.empty();
      Object.entries(colors).forEach(([className, color]) => {
        $colorOptions.append(`
                    <div class="color-option ${className}" 
                         data-color="${color}" 
                         style="background-color: ${color}">
                    </div>
                `);
      });
    }
  }

  // 初始化主题
  function initTheme() {
    console.log("[Roadmap] Initializing theme");
    const isDarkMode = localStorage.getItem("darkMode") === "true";
    console.log("[Roadmap] Dark mode from localStorage:", isDarkMode);

    if (isDarkMode) {
      document.body.classList.add("dark-mode");
      $("#themeSwitch .layui-icon").removeClass("layui-icon-circle-dot").addClass("layui-icon-light");
      updateTaskCardsColor();
      updateColorOptions();
    } else {
      $("#themeSwitch .layui-icon").addClass("layui-icon-circle-dot").removeClass("layui-icon-light");
    }
  }

  // 切换主题
  function toggleTheme() {
    console.log("[Roadmap] Toggling theme");
    const isDarkMode = document.body.classList.toggle("dark-mode");
    console.log("[Roadmap] Setting dark mode to:", isDarkMode);

    // 保存到 localStorage
    localStorage.setItem("darkMode", isDarkMode);

    const $icon = $("#themeSwitch .layui-icon");
    if (isDarkMode) {
      $icon.removeClass("layui-icon-circle-dot").addClass("layui-icon-light");
    } else {
      $icon.removeClass("layui-icon-light").addClass("layui-icon-circle-dot");
    }

    // 更新layer弹窗样式
    if (isDarkMode) {
      layer.style = function (index, options) {
        this.getChildFrame("body", index).addClass("dark-mode");
      };
    } else {
      layer.style = function (index, options) {
        this.getChildFrame("body", index).removeClass("dark-mode");
      };
    }

    // 更新颜色选择器和任务卡片颜色
    updateColorOptions();
    updateTaskCardsColor();
  }

  // 绑定主题切换事件
  $("#themeSwitch").on("click", function () {
    toggleTheme();
  });

  // 检查登录状态
  function checkLogin() {
    console.log("[Roadmap] Checking login status");
    $.get("/roadmap/api/check_login", function (res) {
      try {
        const data = typeof res === "string" ? JSON.parse(res) : res;
        if (data.code == 0 && data.data) {
          // 已登录
          $("#currentUser").text(data.data.username);
          loadTasks();
        } else {
          // 未登录，显示登录框
          showLoginForm();
        }
      } catch (e) {
        console.error("[Roadmap] Error checking login status:", e);
        layer.msg("检查登录状态失败", { icon: 2 });
      }
    });
  }

  // 显示登录表单
  function showLoginForm() {
    console.log("[Roadmap] Showing login form");
    layer.open({
      type: 1,
      title: "用户登录",
      content: $("#loginFormTpl").html(),
      closeBtn: 0,
      area: ["600px", "500px"],
    });
  }

  // 登录表单提交
  form.on("submit(loginSubmit)", function (data) {
    console.log("[Roadmap] Submitting login form");
    $.ajax({
      url: "/roadmap/api/login",
      method: "POST",
      contentType: "application/json",
      data: JSON.stringify(data.field),
      success: function (res) {
        try {
          const data = typeof res === "string" ? JSON.parse(res) : res;
          if (data.code === 0) {
            layer.closeAll();
            $("#currentUser").text(data.data.username);
            loadTasks();
            layer.msg("登录成功", { icon: 1 });
            localStorage.setItem("Roadmap_PlayerId", data.data.user_id);
          } else {
            layer.msg("登录失败: " + data.msg, { icon: 2 });
          }
        } catch (e) {
          console.error("[Roadmap] Error parsing login response:", e);
          layer.msg("数据解析错误", { icon: 2 });
        }
      },
    });
    return false;
  });

  // 退出登录
  $(".logout-btn").on("click", function () {
    console.log("[Roadmap] Logging out");
    layer.confirm("确定要退出登录吗？", { icon: 3, title: "提示" }, function (index) {
      $.get("/roadmap/api/logout", function (res) {
        try {
          const data = typeof res === "string" ? JSON.parse(res) : res;
          if (data.code === 0) {
            layer.msg("已退出登录", { icon: 1 });
            setTimeout(() => {
              window.location.reload();
            }, 1000);
          } else {
            layer.msg("退出失败: " + data.msg, { icon: 2 });
          }
        } catch (e) {
          console.error("[Roadmap] Error logging out:", e);
          layer.msg("数据解析错误", { icon: 2 });
        }
      });
      layer.close(index);
    });
  });

  // 初始化数据
  function loadTasks() {
    console.log("[Roadmap] Loading tasks");
    $.get("/roadmap/api", function (res) {
      try {
        const data = typeof res === "string" ? JSON.parse(res) : res;
        if (data.code === 0) {
          renderTasks(data.data);
          initTheme();
        } else {
          layer.msg("加载任务失败: " + data.msg, { icon: 2 });
        }
      } catch (e) {
        console.error("[Roadmap] Error parsing response:", e);
        layer.msg("数据解析错误", { icon: 2 });
      }
    });
  }

  // 渲染任务卡片
  function renderTasks(tasks) {
    console.log("[Roadmap] Rendering tasks:", tasks);
    $(".task-list").empty();

    const taskGroups = {
      PLANNED: [],
      WORKING: [],
      COMPLETED: [],
    };

    // 按状态分组
    tasks.forEach((task) => {
      if (taskGroups[task.status]) {
        taskGroups[task.status].push(task);
      }
    });

    // 对每个状态的任务排序
    Object.keys(taskGroups).forEach((status) => {
      // 自定义排序逻辑：
      // 1. 置顶任务（order=-1）排在前面
      // 2. 置顶任务按edittime倒序排序（最新置顶的在最前面）
      // 3. 普通任务按order正序排序
      taskGroups[status].sort((a, b) => {
        // 处理置顶任务
        if (a.order === -1 && b.order !== -1) {
          return -1; // a是置顶，排在前面
        }
        if (a.order !== -1 && b.order === -1) {
          return 1; // b是置顶，排在前面
        }
        if (a.order === -1 && b.order === -1) {
          // 两个都是置顶，按edittime倒序排序
          return b.edittime - a.edittime;
        }
        // 普通任务按order正序排序
        return (a.order || 0) - (b.order || 0);
      });
      
      const listId = `#${status.toLowerCase()}-list`;
      taskGroups[status].forEach((task) => {
        $(listId).append(createTaskCard(task));
      });
    });

    initDragAndDrop();
    updateTaskCounts();
  }

  // 创建任务卡片
  function createTaskCard(task) {
    console.log("[Roadmap] Creating task card:", task);

    // 根据任务状态决定是否显示完成按钮和按钮图标
    let completeButton = "";
    if (task.status !== "COMPLETED") {
      if (task.is_cycle_task) {
        // 周期任务，显示"完成本次任务"按钮
        completeButton = `
                <button class="layui-btn layui-btn-xs layui-btn-normal complete-cycle-task" 
                        data-task-id="${task.id}" 
                        title="完成本次任务">
                    <i class="layui-icon">&#xe605;</i>
                </button>
            `;
      } else {
        // 普通任务
        const nextStatus = task.status === "PLANNED" ? "WORKING" : "COMPLETED";
        const buttonIcon = task.status === "PLANNED" ? "&#xe63c;" : "&#xe605;"; // 工具: &#xe63c;, 对勾: &#xe605;
        completeButton = `
                <button class="layui-btn layui-btn-xs layui-btn-normal complete-task" 
                        data-next-status="${nextStatus}" 
                        title="${task.status === "PLANNED" ? "开始工作" : "标记完成"}">
                    <i class="layui-icon">${buttonIcon}</i>
                </button>
            `;
      }
    }

    // 添加置顶按钮，仅在工作中状态显示
    let pinButton = "";
    if (task.status === "WORKING" || task.status === "PLANNED") {
      const isPinned = task.order === -1;
      pinButton = `
                <button class="layui-btn layui-btn-xs layui-bg-blue pin-task" 
                        data-pinned="${isPinned}" 
                        title="${isPinned ? "取消置顶" : "置顶"}">
                    <i class="layui-icon">${isPinned ? "&#xe61a;" : "&#xe619;"}</i>
                </button>
            `;
    }

    // 周期任务标记
    let cycleTaskBadge = "";
    if (task.is_cycle_task) {
      cycleTaskBadge = `
                <span class="cycle-task-badge" style="background-color: #ffb800; color: white; padding: 2px 6px; border-radius: 10px; font-size: 12px; margin-left: 8px;">
                    周期: ${task.cycle_duration || 0}天
                </span>
            `;
    }
    
    return $(`
            <div class="task-card" 
                 data-id="${task.id}" 
                 data-order="${task.order || 0}"
                 data-task='${JSON.stringify(task)}'
                 style="background-color: ${task.color || "#ffffff"}"
                 draggable="true">
                <div class="task-content">
                    <h3>${task.name}${cycleTaskBadge}</h3>
                    <p>${task.description || ""}</p>
                    ${task.is_cycle_task && task.next_reminder_time ? `<p style="font-size: 12px; color: #999;">下次提醒: ${new Date(task.next_reminder_time * 1000).toLocaleString()}</p>` : ""}
                    <div class="task-actions">
                        ${completeButton}
                        ${pinButton}
                        <button class="layui-btn layui-btn-xs edit-task">
                            <i class="layui-icon">&#xe642;</i>
                        </button>
                        <button class="layui-btn layui-btn-xs layui-btn-danger delete-task">
                            <i class="layui-icon">&#xe640;</i>
                        </button>
                    </div>
                </div>
            </div>
        `);
  }

  // 打开任务表单
  function openTaskForm(title, data = {}, submitCallback) {
    console.log("[Roadmap] Opening task form:", { title, data });

    layer.open({
      type: 1,
      title: title,
      area: ["500px", "480px"], // 增加高度以容纳周期任务配置
      content: $("#taskFormTpl").html(),
      success: function (layero) {
        const $form = $(layero).find(".layui-form");

        // 填充表单数据
        $form.find("input[name=name]").val(data.name || "");
        $form.find("textarea[name=description]").val(data.description || "");

        // 渲染颜色选项
        const $colorOptions = $form.find("#colorOptions");
        $colorOptions.empty().addClass("color-options");

        // 添加颜色选择器容器
        const $colorContainer = $('<div class="color-picker-container"></div>');
        $colorOptions.append($colorContainer);

        // 渲染颜色选项
        const colors = getCurrentThemeColors();
        Object.entries(colors).forEach(([className, color]) => {
          const $colorBox = $(`
                        <div class="color-option ${className} ${data.color === color ? "selected" : ""}" 
                             data-color="${color}"
                             title="${color}">
                            <div class="color-preview"></div>
                            ${data.color === color ? '<i class="layui-icon layui-icon-ok"></i>' : ""}
                        </div>
                    `);

          $colorContainer.append($colorBox);
        });

        // 添加隐藏的颜色输入
        $colorOptions.append(`
                    <input type="hidden" name="color" value="${data.color || "#ffffff"}">
                `);

        // 颜色选择事件
        $colorOptions.on("click", ".color-option", function () {
          const $this = $(this);
          const color = $this.data("color");
          console.log("[Roadmap] Color selected:", color);

          // 更新隐藏输入值
          $form.find("input[name=color]").val(color);

          // 更新选中状态
          $colorOptions.find(".color-option").removeClass("selected").find(".layui-icon").remove();
          $this.addClass("selected").append('<i class="layui-icon layui-icon-ok"></i>');
        });

        // 周期任务配置初始化
        const $isCycleTask = $form.find("input[name=is_cycle_task]");
        const $cycleDurationRow = $form.find(".cycle-duration-row");
        
        // 填充初始数据
        $isCycleTask.prop("checked", data.is_cycle_task === 1);
        $form.find("input[name=cycle_duration]").val(data.cycle_duration || "");
        
        // 控制周期时长输入框的显示/隐藏
        if (data.is_cycle_task === 1) {
          $cycleDurationRow.show();
        } else {
          $cycleDurationRow.hide();
        }
        
        // 监听周期任务开关变化 - 使用layui的form.on事件
        form.on('switch(is_cycle_task)', function(data) {
          if (data.elem.checked) {
            $cycleDurationRow.show();
          } else {
            $cycleDurationRow.hide();
          }
        });

        form.render();
      },
    });

    // 表单提交
    form.on("submit(submitTask)", function (formData) {
      console.log("[Roadmap] Submitting task form:", formData.field);
      
      // 处理周期任务相关字段
      const $form = $(this).closest(".layui-form");
      const isCycleTask = $form.find("input[name=is_cycle_task]").is(":checked");
      formData.field.is_cycle_task = isCycleTask ? 1 : 0;
      
      // 如果不是周期任务，清空周期时长
      if (!isCycleTask) {
        formData.field.cycle_duration = null;
      } else if (formData.field.cycle_duration) {
        // 确保周期时长是数字类型
        formData.field.cycle_duration = parseInt(formData.field.cycle_duration);
      }
      
      submitCallback(formData.field);
      return false;
    });
  }

  // 初始化拖拽
  function initDragAndDrop() {
    console.log("[Roadmap] Initializing drag and drop");

    const taskCards = document.querySelectorAll(".task-card");
    const taskLists = document.querySelectorAll(".task-list");

    taskCards.forEach((card) => {
      card.addEventListener("dragstart", handleDragStart);
      card.addEventListener("dragend", handleDragEnd);
    });

    taskLists.forEach((list) => {
      list.addEventListener("dragover", handleDragOver);
      list.addEventListener("dragleave", handleDragLeave);
      list.addEventListener("drop", handleDrop);
    });
  }

  function handleDragStart(e) {
    console.log("[Roadmap] Drag start");
    e.dataTransfer.setData("text/plain", e.target.dataset.id);
    e.target.classList.add("dragging");
  }

  function handleDragEnd(e) {
    console.log("[Roadmap] Drag end");
    e.target.classList.remove("dragging");
    document.querySelectorAll(".task-list").forEach((list) => {
      list.classList.remove("drag-over");
    });
  }

  function handleDragOver(e) {
    e.preventDefault();
    e.currentTarget.classList.add("drag-over");

    const draggingCard = document.querySelector(".dragging");
    const list = e.currentTarget;
    const cards = [...list.querySelectorAll(".task-card:not(.dragging)")];
    
    // 分离置顶卡片和普通卡片
    const pinnedCards = cards.filter(card => parseInt(card.dataset.order) === -1);
    const normalCards = cards.filter(card => parseInt(card.dataset.order) !== -1);
    
    // 检查拖动的卡片是否是置顶卡片
    const isDraggingPinned = parseInt(draggingCard.dataset.order) === -1;
    
    // 找到合适的插入位置
    const afterCard = cards.find((card) => {
      const rect = card.getBoundingClientRect();
      const cardVerticalCenter = rect.top + rect.height / 2;
      return e.clientY < cardVerticalCenter;
    });
    
    // 如果拖动的是置顶卡片，只能放在其他置顶卡片之间或所有置顶卡片之后
    if (isDraggingPinned) {
      if (afterCard && parseInt(afterCard.dataset.order) === -1) {
        // 放在另一个置顶卡片之前
        list.insertBefore(draggingCard, afterCard);
      } else if (pinnedCards.length > 0) {
        // 放在所有置顶卡片之后
        const lastPinnedCard = pinnedCards[pinnedCards.length - 1];
        list.insertBefore(draggingCard, lastPinnedCard.nextSibling);
      } else {
        // 没有其他置顶卡片，放在列表开头
        list.insertBefore(draggingCard, list.firstChild);
      }
    } else {
      // 拖动的是普通卡片，只能放在普通卡片之间或所有普通卡片之后
      if (afterCard && parseInt(afterCard.dataset.order) !== -1) {
        // 放在另一个普通卡片之前
        list.insertBefore(draggingCard, afterCard);
      } else if (normalCards.length > 0) {
        // 放在所有普通卡片之后
        const lastNormalCard = normalCards[normalCards.length - 1];
        list.insertBefore(draggingCard, lastNormalCard.nextSibling);
      } else if (pinnedCards.length > 0) {
        // 没有普通卡片，放在所有置顶卡片之后
        const lastPinnedCard = pinnedCards[pinnedCards.length - 1];
        list.insertBefore(draggingCard, lastPinnedCard.nextSibling);
      } else {
        // 列表为空，直接添加
        list.appendChild(draggingCard);
      }
    }
  }

  function handleDragLeave(e) {
    e.currentTarget.classList.remove("drag-over");
  }

  function handleDrop(e) {
    e.preventDefault();
    e.currentTarget.classList.remove("drag-over");

    const taskId = e.dataTransfer.getData("text/plain");
    const newStatus = e.currentTarget.parentElement.dataset.status;

    // 修改排序逻辑：获取所有同状态的卡片
    const allCards = [...e.currentTarget.querySelectorAll(".task-card")];
    const droppedCard = allCards.find((card) => card.dataset.id === taskId);
    
    // 分离置顶卡片和普通卡片
    const pinnedCards = allCards.filter(card => parseInt(card.dataset.order) === -1);
    const normalCards = allCards.filter(card => parseInt(card.dataset.order) !== -1);
    
    // 检查被拖动的卡片是否是置顶卡片
    const isDroppedCardPinned = parseInt(droppedCard.dataset.order) === -1;
    
    // 计算新的顺序，只处理普通卡片
    const normalCardIndex = normalCards.indexOf(droppedCard);
    let newOrder = normalCardIndex;
    
    console.log("[Roadmap] Dropping task:", {
      taskId,
      newStatus,
      newOrder,
      isDroppedCardPinned,
      allCards: allCards.map((card) => card.dataset.id),
      pinnedCards: pinnedCards.map((card) => card.dataset.id),
      normalCards: normalCards.map((card) => card.dataset.id)
    });

    // 更新所有普通卡片的顺序
    normalCards.forEach((card, index) => {
      const cardId = card.dataset.id;
      if (cardId !== taskId && index !== parseInt(card.dataset.order)) {
        updateTaskOrder(cardId, index);
      }
    });

    // 获取被拖动卡片的任务数据
    const droppedTask = JSON.parse(droppedCard.getAttribute('data-task'));
    
    // 检查是否是周期任务且目标状态是已完成
    if (droppedTask.is_cycle_task && newStatus === 'COMPLETED') {
      layer.msg('周期任务不能标记为已完成，请使用"完成本次任务"按钮', { icon: 2 });
      // 重新加载任务列表，恢复原始状态
      loadTasks();
      return;
    }
    
    // 更新拖动卡片的状态和顺序
    // 如果是置顶卡片，保持其order=-1
    if (isDroppedCardPinned) {
      updateTaskStatus(taskId, newStatus, -1);
    } else {
      updateTaskStatus(taskId, newStatus, newOrder);
    }
  }

  // 添加新函数：仅更新任务顺序
  function updateTaskOrder(taskId, order) {
    console.log("[Roadmap] Updating task order:", { taskId, order });
    $.ajax({
      url: `/roadmap/api/${taskId}`,
      method: "PUT",
      contentType: "application/json",
      data: JSON.stringify({ order: order }),
      success: function (res) {
        try {
          const data = typeof res === "string" ? JSON.parse(res) : res;
          if (data.code !== 0) {
            console.error("[Roadmap] Error updating task order:", data.msg);
          }
        } catch (e) {
          console.error("[Roadmap] Error parsing response:", e);
        }
      },
    });
  }

  // 更新任务状态
  function updateTaskStatus(taskId, status, order) {
    console.log("[Roadmap] Updating task status:", { taskId, status, order });
    
    // 获取任务详情，检查是否是周期任务
    $.ajax({
      url: `/roadmap/api/${taskId}`,
      method: "GET",
      success: function (res) {
        try {
          const data = typeof res === "string" ? JSON.parse(res) : res;
          if (data.code === 0 && data.data) {
            const task = data.data;
            
            // 如果是周期任务且目标状态是已完成，阻止更新
            if (task.is_cycle_task && status === 'COMPLETED') {
              layer.msg('周期任务不能标记为已完成，请使用"完成本次任务"按钮', { icon: 2 });
              loadTasks();
              return;
            }
            
            // 不是周期任务或目标状态不是已完成，继续更新
            $.ajax({
              url: `/roadmap/api/${taskId}`,
              method: "PUT",
              contentType: "application/json",
              data: JSON.stringify({
                status: status,
                order: order,
              }),
              success: function (res) {
                try {
                  const data = typeof res === "string" ? JSON.parse(res) : res;
                  if (data.code === 0) {
                    // 不再立即刷新,让用户看到拖拽效果
                    setTimeout(loadTasks, 500);
                  } else {
                    layer.msg("更新失败: " + data.msg, { icon: 2 });
                    loadTasks(); // 失败时立即刷新
                  }
                } catch (e) {
                  console.error("[Roadmap] Error parsing response:", e);
                  layer.msg("数据解析错误", { icon: 2 });
                  loadTasks();
                }
              },
            });
          }
        } catch (e) {
          console.error("[Roadmap] Error parsing task details:", e);
          layer.msg("获取任务详情失败", { icon: 2 });
          loadTasks();
        }
      },
    });
  }

  // 置顶/取消置顶任务
  function togglePinTask(taskId, isPinned) {
    console.log("[Roadmap] Toggling pin status:", { taskId, isPinned });
    const newOrder = isPinned ? 0 : -1; // 置顶时order为-1，取消置顶时恢复正常顺序
    const currentTime = Math.floor(Date.now() / 1000);
    
    $.ajax({
      url: `/roadmap/api/${taskId}`,
      method: "PUT",
      contentType: "application/json",
      data: JSON.stringify({
        order: newOrder,
        edittime: currentTime // 更新edittime为当前时间
      }),
      success: function (res) {
        try {
          const data = typeof res === "string" ? JSON.parse(res) : res;
          if (data.code === 0) {
            layer.msg(isPinned ? "取消置顶成功" : "置顶成功", { icon: 1 });
            
            // 直接更新页面上的卡片排序，而不是重新加载
            // 1. 获取被置顶的卡片
            const $pinnedCard = $(`.task-card[data-id="${taskId}"]`);
            if (!$pinnedCard.length) return;
            
            // 2. 获取卡片所在的任务列表
            const $taskList = $pinnedCard.closest(".task-list");
            
            // 3. 获取卡片的任务数据
            let taskData = $pinnedCard.data("task");
            if (!taskData) {
              // 如果没有task数据，从data-task属性获取
              taskData = JSON.parse($pinnedCard.attr("data-task"));
            }
            
            // 4. 更新任务数据
            taskData.order = newOrder;
            taskData.edittime = currentTime;
            $pinnedCard.data("task", taskData);
            $pinnedCard.attr("data-task", JSON.stringify(taskData));
            $pinnedCard.attr("data-order", newOrder);
            
            // 5. 获取当前列表中的所有卡片
            const $allCards = $taskList.find(".task-card");
            
            // 6. 将卡片转换为数组并排序
            const sortedCards = $allCards.toArray().sort((a, b) => {
              const aTask = JSON.parse($(a).attr("data-task"));
              const bTask = JSON.parse($(b).attr("data-task"));
              
              // 自定义排序逻辑，与renderTasks函数中的排序逻辑一致
              // 1. 置顶任务（order=-1）排在前面
              // 2. 置顶任务按edittime倒序排序（最新置顶的在最前面）
              // 3. 普通任务按order正序排序
              if (aTask.order === -1 && bTask.order !== -1) {
                return -1; // a是置顶，排在前面
              }
              if (aTask.order !== -1 && bTask.order === -1) {
                return 1; // b是置顶，排在前面
              }
              if (aTask.order === -1 && bTask.order === -1) {
                // 两个都是置顶，按edittime倒序排序
                return bTask.edittime - aTask.edittime;
              }
              // 普通任务按order正序排序
              return (aTask.order || 0) - (bTask.order || 0);
            });
            
            // 7. 重新排列DOM中的卡片
            sortedCards.forEach(card => {
              $taskList.append(card);
            });
            
            // 8. 重新初始化拖拽功能
            initDragAndDrop();
            
            // 9. 更新置顶按钮的状态
            const $pinBtn = $pinnedCard.find(".pin-task");
            if ($pinBtn.length) {
              $pinBtn.data("pinned", !isPinned);
              $pinBtn.attr("data-pinned", !isPinned);
              $pinBtn.attr("title", !isPinned ? "取消置顶" : "置顶");
              $pinBtn.find(".layui-icon").html(!isPinned ? "&#xe61a;" : "&#xe619;");
            }
          } else {
            layer.msg("操作失败: " + data.msg, { icon: 2 });
          }
        } catch (e) {
          console.error("[Roadmap] Error parsing response:", e);
          layer.msg("数据解析错误", { icon: 2 });
        }
      },
    });
  }

  // 添加节流函数
  function throttle(func, wait) {
    let timeout = null;
    let previous = 0;
    
    return function(...args) {
      const now = Date.now();
      const remaining = wait - (now - previous);
      
      if (remaining <= 0 || remaining > wait) {
        if (timeout) {
          clearTimeout(timeout);
          timeout = null;
        }
        previous = now;
        func.apply(this, args);
      } else if (!timeout) {
        timeout = setTimeout(() => {
          previous = Date.now();
          timeout = null;
          func.apply(this, args);
        }, remaining);
      }
    };
  }

  // 修改添加任务的处理逻辑
  $(".add-task-btn").on("click", throttle(function() {
    const status = $(this).data("status");
    console.log("[Roadmap] Opening add task dialog for status:", status);

    openTaskForm("添加任务", { status }, function(formData) {
      formData.status = status;
      formData.playerId = localStorage.getItem("Roadmap_PlayerId");
      
      // 生成临时ID
      const tempId = 'temp_' + Date.now();
      
      // 创建临时任务卡片并立即显示
      const tempTask = {
        id: tempId,
        name: formData.name,
        description: formData.description,
        color: formData.color,
        status: status,
        order: $(`#${status.toLowerCase()}-list .task-card`).length // 添加到列表末尾
      };
      
      // 关闭表单
      layer.closeAll();
      
      // 立即在界面上添加任务卡片
      const $tempCard = createTaskCard(tempTask);
      $tempCard.addClass('task-card-pending'); // 添加待处理样式
      $(`#${status.toLowerCase()}-list`).append($tempCard);
      updateTaskCounts();

      // 发送异步请求
      $.ajax({
        url: "/roadmap/api",
        method: "POST",
        contentType: "application/json",
        data: JSON.stringify(formData),
        success: function(res) {
          try {
            const data = typeof res === "string" ? JSON.parse(res) : res;
            if (data.code === 0) {
              // 更新临时卡片的ID和其他服务器返回的数据
              $tempCard
                .removeClass('task-card-pending')
                .attr('data-id', data.data.id)
                .data('task', data.data);
              
              layer.msg("添加成功", { icon: 1 });
            } else {
              // 添加失败，移除临时卡片
              $tempCard.remove();
              updateTaskCounts();
              layer.msg("添加失败: " + data.msg, { icon: 2 });
            }
          } catch (e) {
            console.error("[Roadmap] Error parsing response:", e);
            // 添加失败，移除临时卡片
            $tempCard.remove();
            updateTaskCounts();
            layer.msg("数据解析错误", { icon: 2 });
          }
        },
        error: function() {
          // 请求失败，移除临时卡片
          $tempCard.remove();
          updateTaskCounts();
          layer.msg("网络请求失败", { icon: 2 });
        }
      });
    });
  }, 1000)); // 1秒的节流时间



  // 编辑任务
  $(document).on("click", ".edit-task", function (e) {
    e.stopPropagation();
    const taskCard = $(this).closest(".task-card");
    const taskData = taskCard.data("task");
    const taskId = taskData.id;

    console.log("[Roadmap] Edit task:", taskData);

    openTaskForm("编辑任务", taskData, function (formData) {
      $.ajax({
        url: `/roadmap/api/${taskId}`,
        method: "PUT",
        contentType: "application/json",
        data: JSON.stringify(formData),
        success: function (res) {
          try {
            const data = typeof res === "string" ? JSON.parse(res) : res;
            if (data.code === 0) {
              layer.closeAll();
              loadTasks();
              layer.msg("更新成功", { icon: 1 });
            } else {
              layer.msg("更新失败: " + data.msg, { icon: 2 });
            }
          } catch (e) {
            console.error("[Roadmap] Error parsing response:", e);
            layer.msg("数据解析错误", { icon: 2 });
          }
        },
      });
    });
  });

  // 删除任务
  $(document).on("click", ".delete-task", function (e) {
    e.stopPropagation();
    const taskCard = $(this).closest(".task-card");
    const taskId = taskCard.data("id");

    console.log("[Roadmap] Deleting task:", taskId);

    layer.confirm("确定要删除这个任务吗？", { icon: 3, title: "提示" }, function (index) {
      $.ajax({
        url: `/roadmap/api/${taskId}`,
        method: "DELETE",
        success: function (res) {
          try {
            const data = typeof res === "string" ? JSON.parse(res) : res;
            if (data.code === 0) {
              loadTasks();
              layer.msg("删除成功", { icon: 1 });
            } else {
              layer.msg("删除失败: " + data.msg, { icon: 2 });
            }
          } catch (e) {
            console.error("[Roadmap] Error parsing response:", e);
            layer.msg("数据解析错误", { icon: 2 });
          }
        },
      });
      layer.close(index);
    });
  });

  // 完成周期任务
  $(document).on("click", ".complete-cycle-task", function (e) {
    e.stopPropagation();
    const taskCard = $(this).closest(".task-card");
    const taskId = taskCard.data("id");

    console.log("[Roadmap] Complete cycle task:", taskId);

    layer.confirm("确定要完成本次周期任务吗？系统将自动计算下次提醒时间。", { icon: 3, title: "提示" }, function (index) {
      $.ajax({
        url: `/roadmap/api/${taskId}/complete_cycle`,
        method: "POST",
        success: function (res) {
          try {
            const data = typeof res === "string" ? JSON.parse(res) : res;
            if (data.code === 0) {
              layer.msg(data.msg, { icon: 1 });
              loadTasks(); // 刷新任务列表，更新下次提醒时间
            } else {
              layer.msg("操作失败: " + data.msg, { icon: 2 });
            }
          } catch (e) {
            console.error("[Roadmap] Error parsing response:", e);
            layer.msg("数据解析错误", { icon: 2 });
          }
        },
      });
      layer.close(index);
    });
  });

  // 绑定任务状态切换事件
  $(document).on("click", ".complete-task", function (e) {
    e.stopPropagation();
    const $btn = $(this);
    const $card = $btn.closest(".task-card");
    const taskId = $card.data("id");
    const nextStatus = $btn.data("next-status");

    console.log("[Roadmap] Complete task clicked:", { taskId, nextStatus });

    // 确认对话框
    layer.confirm("确定要更新任务状态吗？", { icon: 3, title: "提示" }, function (index) {
      updateTaskStatus(taskId, nextStatus);
      layer.close(index);
    });
  });

  // 绑定置顶按钮点击事件
  $(document).on("click", ".pin-task", function (e) {
    e.stopPropagation();
    const $btn = $(this);
    const $card = $btn.closest(".task-card");
    const taskId = $card.data("id");
    const isPinned = $btn.data("pinned");

    console.log("[Roadmap] Pin task clicked:", { taskId, isPinned });

    // 确认对话框
    layer.confirm(isPinned ? "确定要取消置顶吗？" : "确定要置顶吗？", { icon: 3, title: "提示" }, function (index) {
      togglePinTask(taskId, isPinned);
      layer.close(index);
    });
  });

  // 更新任务数量显示
  function updateTaskCounts() {
    console.log("[Roadmap] Updating task counts");
    
    // 获取每个状态的任务数量
    const statusCounts = {
        PLANNED: $("#planned-list .task-card").length,
        WORKING: $("#working-list .task-card").length,
        COMPLETED: $("#completed-list .task-card").length
    };
    
    // 更新显示
    Object.entries(statusCounts).forEach(([status, count]) => {
        $(`.task-column[data-status="${status}"] .task-count`).text(`(${count})`);
    });
    
    console.log("[Roadmap] Task counts updated:", statusCounts);
  }

  // 修改初始化逻辑
  checkLogin(); // 替换原来的 loadTasks()
});
