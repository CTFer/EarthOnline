# 车牌修改功能说明

## 功能概述

本功能允许通过企业微信发送指令来修改停车场系统中的车牌号码，支持完整的修改流程和状态跟踪。

## 功能特性

1. **企业微信指令支持**：支持 "修改，原车牌，新车牌" 格式的指令
2. **数据验证**：检查原车牌是否存在，新车牌是否已存在
3. **状态跟踪**：使用 `status` 字段标记为 `change`，在 `remark` 字段记录新车牌
4. **客户端处理**：客户端自动检测并处理车牌修改请求
5. **通知机制**：修改完成后自动发送企业微信通知

## 使用方法

### 1. 企业微信指令

在企业微信群中发送以下格式的消息：

```
修改：川A12345，川B67890
```

**指令格式说明：**
- `修改`：固定关键词
- `川A12345`：原车牌号
- `川B67890`：新车牌号
- 分隔符：支持中文逗号、英文逗号、空格等

### 2. 处理流程

1. **服务器端处理**：
   - 接收企业微信指令
   - 验证原车牌是否存在
   - 检查新车牌是否已存在
   - 在 `car_park` 表中创建记录，`status` 设为 `change`，`remark` 记录新车牌

2. **客户端处理**：
   - 定期检查 `status` 为 `change` 的请求
   - 更新 `Sys_Park_Plate` 表中的 `plateNumber` 字段
   - 更新 `Sys_Park_PlateCharge` 表中的相关记录
   - 将状态更新为 `changed`，在 `comment` 中添加说明
   - 通过现有的 `update_car_park_status` 函数自动发送企业微信通知

## 数据库结构

### car_park 表
```sql
CREATE TABLE car_park (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    owner TEXT NOT NULL,
    car_number TEXT NOT NULL,
    time TEXT NOT NULL,
    addtime TEXT NOT NULL,
    status TEXT NOT NULL,  -- 'pending', 'complete', 'failed', 'change'
    remark TEXT,           -- 存储新车牌号
    comment TEXT
);
```

### 关键字段说明
- `status = 'change'`：标识为车牌修改请求（待处理）
- `status = 'changed'`：标识为车牌修改完成
- `remark`：存储新车牌号（仅用于修改功能）
- `comment`：存储备注信息（续期功能使用，修改完成后也存储说明）
- `car_number`：原车牌号

### 字段使用规则
- **续期功能**：使用 `comment` 字段存储续期相关信息
- **修改功能**：使用 `remark` 字段存储新车牌，完成后在 `comment` 字段存储修改说明
- **API返回**：同时返回 `remark` 和 `comment` 字段，客户端根据 `status` 选择使用

## API 接口

### 1. 获取待处理请求
```
GET /car_park/review
Headers: X-API-Key: 95279527
```

返回包含 `status = 'pending'` 或 `status = 'change'` 的请求列表。

### 2. 更新请求状态
```
POST /car_park/review
Headers: X-API-Key: 95279527
Content-Type: application/json

{
    "car_number": "川A12345",
    "status": "changed",
    "comment": "车牌由川A12345改为川B67890"
}
```


## 错误处理

### 常见错误情况

1. **原车牌不存在**
   ```
   原车牌 川A12345 不存在，无法修改
   ```

2. **新车牌已存在**
   ```
   新车牌 川B67890 已存在，无法修改
   ```

3. **格式错误**
   ```
   格式错误，正确格式：修改：原车牌，新车牌
   例如：修改：川A12345，川B67890
   ```

4. **权限不足**
   ```
   您无权进行修改车牌操作
   ```

## 日志记录

### 服务器端日志
```
[Car_Park] 车牌修改申请已提交：
原车牌：川A12345
新车牌：川B67890
提交时间：2024-01-15 10:30:00
状态：等待客户端处理
```

### 客户端日志
```
[调试] 开始处理车牌修改：川A12345 -> 川B67890
[调试] 车牌修改成功：川A12345 -> 川B67890
[调试] 车牌修改通知发送成功：川A12345 -> 川B67890
```

## 测试

使用提供的测试脚本验证功能：

```bash
python test_plate_change.py
```

测试脚本会：
1. 创建测试数据
2. 验证API接口
3. 测试通知功能
4. 清理测试数据

## 状态流程

### 车牌修改状态流转
1. **change**：企业微信指令创建修改请求
2. **changed**：客户端处理完成，数据库已更新

### 续期状态流转
1. **pending**：企业微信指令创建续期请求
2. **complete**：客户端处理完成，续期成功
3. **failed**：处理失败

## 常见问题修复

### 1. 缺少新车牌信息错误
**问题**：客户端报错 "车牌修改失败：缺少新车牌信息"
**原因**：数据库字段使用不一致，需要同时返回 `remark` 和 `comment` 字段
**修复**：修改返回数据结构，同时返回 `remark` 字段（新车牌）和 `comment` 字段（备注）

### 2. 车主姓名显示错误
**问题**：owner字段显示为"系统管理员"而不是真实车主姓名
**原因**：创建修改记录时没有从 `Sys_Park_Person` 表获取车主信息
**修复**：在创建修改记录前查询 `Sys_Park_Person` 表获取真实车主姓名

## 注意事项

1. **数据一致性**：修改车牌时会同时更新 `Sys_Park_Plate` 和 `Sys_Park_PlateCharge` 表
2. **事务处理**：使用数据库事务确保操作的原子性
3. **错误回滚**：发生错误时自动回滚数据库操作
4. **权限控制**：需要相应的企业微信权限才能执行修改操作
5. **日志记录**：所有操作都有详细的日志记录便于调试
6. **状态隔离**：续期功能只处理 `pending` 状态，修改功能只处理 `change` 状态
7. **通知机制**：使用现有的 `update_car_park_status` 函数发送企业微信通知
8. **字段分离**：续期功能使用 `comment` 字段，修改功能使用 `remark` 字段
9. **车主信息**：自动从 `Sys_Park_Person` 表获取真实车主姓名
10. **数据兼容**：API同时返回 `remark` 和 `comment` 字段，保持向后兼容

## 扩展功能

可以考虑添加的功能：
1. 批量车牌修改
2. 车牌修改历史记录
3. 修改审批流程
4. 自动同步到其他系统
